---
import { Icon } from "astro-icon";
---

<button
  id="theme-toggle"
  class="btn btn-circle btn-ghost btn-sm sm:btn-md"
  aria-label="Toggle theme"
  title="Toggle theme"
>
  <Icon id="theme-icon-light" name="iconoir:sun-light" class="h-6 w-6 hidden" />
  <Icon id="theme-icon-dark" name="iconoir:half-moon" class="h-6 w-6 hidden" />
  <Icon id="theme-icon-system" name="iconoir:settings" class="h-6 w-6" />
</button>

<script>
  import { theme } from "../store/store";
  import { setTheme, getTheme } from "../scripts/theme";

  const updateThemeIcon = (currentTheme: "light" | "dark" | "system") => {
    const iconLight = document.querySelector("#theme-icon-light");
    const iconDark = document.querySelector("#theme-icon-dark");
    const iconSystem = document.querySelector("#theme-icon-system");

    if (iconLight && iconDark && iconSystem) {
      // Hide all icons
      iconLight.classList.add("hidden");
      iconDark.classList.add("hidden");
      iconSystem.classList.add("hidden");

      // Show the appropriate icon
      if (currentTheme === "light") {
        iconLight.classList.remove("hidden");
      } else if (currentTheme === "dark") {
        iconDark.classList.remove("hidden");
      } else {
        iconSystem.classList.remove("hidden");
      }
    }
  };

  const cycleTheme = () => {
    const current = getTheme();
    let next: "light" | "dark" | "system";

    if (current === "light") {
      next = "dark";
    } else if (current === "dark") {
      next = "system";
    } else {
      next = "light";
    }

    setTheme(next);
  };

  let isSetup = false;

  const setupThemeToggle = () => {
    const themeToggle = document.querySelector("#theme-toggle");
    if (!themeToggle) return;

    // Set initial icon state
    updateThemeIcon(theme.get());

    // Only set up listeners once to avoid duplicates
    if (!isSetup) {
      // Listen to theme changes
      theme.listen((value) => {
        updateThemeIcon(value);
      });

      // Cycle theme on click
      themeToggle.addEventListener("click", cycleTheme);

      isSetup = true;
    }
  };

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setupThemeToggle);
  } else {
    setupThemeToggle();
  }

  document.addEventListener("astro:page-load", setupThemeToggle);
</script>
