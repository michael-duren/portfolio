---
import { Icon } from "astro-icon/components";

// Icon mapping matching the refined sketch
const nodes = {
    web: {
        title: "Web Client",
        icons: ["react", "typescript"],
        description:
            "Responsive, high-performance static site with interactive islands.",
    },
    cloud: {
        title: "Cloud",
        icons: ["amazonwebservices-wordmark", "azure"],
        description:
            "Cloud-native infrastructure handling routing, compute, and storage.",
    },
    services: {
        title: "Services",
        icons: ["csharp", "java"],
        description:
            "Microservices ensuring business logic scalability and separation of concerns.",
    },
    db: {
        title: "Data Layer",
        icons: ["postgresql", "microsoftsqlserver"],
        description:
            "Reliable relational data storage with optimized query performance.",
    },
    k8s: {
        title: "Orchestration",
        icon: "kubernetes",
        description:
            "Container orchestration for automated deployment, scaling, and management.",
    },
    tools: {
        title: "Tools & Scripting",
        icons: ["python", "lua"],
        description:
            "Automation scripts for CI/CD pipelines and infrastructure management.",
    },
    observability: {
        title: "Observability",
        icons: ["grafana", "prometheus", "go"],
        description: "Real-time metrics and log monitoring.",
    },
};
---

<!-- Responsive Layout (Big Circle Reaction Vessel) -->
<div
    class="relative w-full aspect-square max-w-2xl mx-auto my-8 md:my-12"
    id="flow-chart-container"
>
    <!-- Circle Container Background -->
    <div
        class="absolute inset-0 rounded-full border-4 border-white/10 shadow-[0_0_50px_rgba(139,92,246,0.15)] bg-gray-900/40 backdrop-blur-xl overflow-hidden"
    >
        <!-- Mixed Liquid Background -->
        <div
            class="absolute inset-0 bg-gradient-to-br from-blue-900/30 via-purple-900/30 to-green-900/30 opacity-60"
        >
        </div>

        <!-- Bubbles -->
        <div class="absolute inset-0">
            <div
                class="absolute bottom-0 left-[10%] w-2 h-2 rounded-full bg-blue-500/50 animate-bubble"
                style="animation-duration: 4s;"
            >
            </div>
            <div
                class="absolute bottom-0 left-[20%] w-3 h-3 rounded-full bg-purple-500/50 animate-bubble"
                style="animation-duration: 5s; animation-delay: 1s;"
            >
            </div>
            <div
                class="absolute bottom-0 left-[40%] w-2 h-2 rounded-full bg-green-500/50 animate-bubble"
                style="animation-duration: 3s; animation-delay: 2s;"
            >
            </div>
            <div
                class="absolute bottom-0 left-[60%] w-4 h-4 rounded-full bg-yellow-500/50 animate-bubble"
                style="animation-duration: 6s; animation-delay: 0.5s;"
            >
            </div>
            <div
                class="absolute bottom-0 left-[80%] w-2 h-2 rounded-full bg-red-500/50 animate-bubble"
                style="animation-duration: 4.5s; animation-delay: 1.5s;"
            >
            </div>
            <div
                class="absolute bottom-0 right-[15%] w-3 h-3 rounded-full bg-cyan-500/50 animate-bubble"
                style="animation-duration: 5.5s; animation-delay: 3s;"
            >
            </div>
        </div>

        <!-- Shine -->
        <!-- Shine -->
        <div
            class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/5 to-transparent rounded-t-full pointer-events-none"
        >
        </div>
    </div>

    <!-- Skip Animation Button -->
    <button
        id="skip-animation-btn"
        class="absolute top-4 right-4 z-50 px-3 py-1.5 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur-md border border-white/10 text-xs font-mono text-gray-300 transition-all duration-300 opacity-0 pointer-events-none hover:scale-105 active:scale-95"
        aria-label="Skip Animation"
    >
        Skip Animation
    </button>

    <!-- Content Container -->
    <div
        class="absolute inset-0 z-10 p-4 md:p-12 w-full h-full flex flex-col justify-evenly items-center"
    >
        <!-- Top Row: Sources -->
        <div
            class="w-full flex justify-between items-start px-12 relative z-20"
        >
            <!-- Web Client -->
            <div
                id="node-web"
                class="flow-node opacity-0 -translate-x-4 hover:scale-105 transition-all duration-500 cursor-help"
                data-desc={nodes.web.description}
            >
                <div
                    class="bg-gray-900/80 border border-blue-400/30 p-4 rounded-2xl flex flex-col items-center gap-2 shadow-lg backdrop-blur-sm"
                >
                    <div class="flex gap-2">
                        {
                            nodes.web.icons.map((i) => (
                                <Icon name={`devicon:${i}`} class="w-6 h-6" />
                            ))
                        }
                    </div>
                    <span class="text-sm text-blue-200 font-mono font-bold"
                        >Web Client</span
                    >
                </div>
            </div>

            <!-- Top Pipe Animation Source (Visual only) -->
            <div
                class="absolute left-1/2 -translate-x-1/2 -top-12 z-0 opacity-50"
            >
                <div
                    class="w-16 h-24 bg-gradient-to-b from-white/10 to-transparent border-x border-white/20"
                >
                </div>
            </div>

            <!-- Orchestration -->
            <div
                id="node-k8s"
                class="flow-node opacity-0 translate-x-4 hover:scale-105 transition-all duration-500 cursor-help"
                data-desc={nodes.k8s.description}
            >
                <div
                    class="bg-blue-900/60 border border-blue-300/30 p-4 rounded-xl shadow-xl shadow-blue-900/50 backdrop-blur-md flex flex-col items-center gap-2"
                >
                    <div class="">
                        <Icon
                            name={`devicon:${nodes.k8s.icon}`}
                            class="w-8 h-8"
                        />
                    </div>
                    <span
                        class="text-sm text-blue-200 font-bold tracking-widest"
                        >KUBERNETES</span
                    >
                </div>
            </div>
        </div>

        <!-- Status Text Container -->
        <div
            id="mixing-status"
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full text-center pointer-events-none z-30 transition-opacity duration-500 opacity-0"
        >
            <span
                class="inline-block px-4 py-2 rounded-full bg-black/80 backdrop-blur-xl border border-white/20 text-sm font-mono text-purple-300 shadow-2xl"
            >
                Initializing...
            </span>
        </div>

        <!-- Middle Row: The Mix (Animating In) -->
        <div
            class="flex-1 w-full flex justify-center items-center md:gap-12 relative my-4"
        >
            <div
                id="node-cloud"
                class="flow-node opacity-0 group relative hover:scale-105 transition-all duration-500 cursor-help"
                data-desc={nodes.cloud.description}
            >
                <div
                    class="bg-gray-800/80 p-4 rounded-xl border border-white/10 flex flex-col items-center gap-3"
                >
                    <span
                        class="text-xs text-gray-400 font-mono uppercase tracking-wider"
                        >Cloud</span
                    >
                    <div class="flex gap-2">
                        {
                            nodes.cloud.icons.map((i) => (
                                <Icon name={`devicon:${i}`} class="w-8 h-8" />
                            ))
                        }
                    </div>
                </div>
            </div>

            <!-- Arrow -->
            <Icon
                name="mdi:arrow-right"
                class="w-8 h-8 text-purple-400/50 arrow-connector opacity-0 transition-opacity duration-500"
            />

            <!-- Services -->
            <div
                id="node-services"
                class="flow-node opacity-0 group relative hover:scale-105 transition-all duration-500 cursor-help"
                data-desc={nodes.services.description}
            >
                <div
                    class="bg-indigo-900/40 p-6 rounded-2xl border border-indigo-400/30 flex flex-col items-center gap-3 shadow-lg"
                >
                    <span
                        class="text-xs text-indigo-200 font-mono uppercase tracking-wider"
                        >Services</span
                    >
                    <div class="flex gap-4">
                        {
                            nodes.services.icons.map((i) => (
                                <Icon name={`devicon:${i}`} class="w-10 h-10" />
                            ))
                        }
                    </div>
                </div>
            </div>

            <!-- Arrow -->
            <Icon
                name="mdi:arrow-right"
                class="w-8 h-8 text-purple-400/50 arrow-connector opacity-0 transition-opacity duration-500"
            />

            <!-- Data -->
            <div
                id="node-db"
                class="flow-node opacity-0 group relative hover:scale-105 transition-all duration-500 cursor-help"
                data-desc={nodes.db.description}
            >
                <div
                    class="bg-gray-800/80 p-4 rounded-full border border-green-500/30 flex flex-col items-center gap-3"
                >
                    <span
                        class="text-xs text-green-200 font-mono uppercase tracking-wider"
                        >Data</span
                    >
                    <div class="flex gap-2">
                        {
                            nodes.db.icons.map((i) => (
                                <Icon name={`devicon:${i}`} class="w-8 h-8" />
                            ))
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Row: Supporting Tools -->
        <div class="w-full flex justify-between items-end px-4 pb-4">
            <!-- Tools -->
            <div
                id="node-tools"
                class="flow-node opacity-0 bg-yellow-900/20 border border-yellow-500/30 p-4 rounded-2xl backdrop-blur-sm hover:scale-105 transition-all duration-500 cursor-help"
                data-desc={nodes.tools.description}
            >
                <div
                    class="text-xs text-yellow-200/80 mb-2 font-bold uppercase tracking-wider"
                >
                    Tools & Scripting
                </div>
                <div class="flex gap-3">
                    {
                        nodes.tools.icons.map((i) => (
                            <Icon name={`devicon:${i}`} class="w-6 h-6" />
                        ))
                    }
                </div>
            </div>

            <!-- Description Bubble -->
            <div
                class="absolute bottom-4 left-1/2 -translate-x-1/2 w-96 text-center pointer-events-none z-30"
            >
                <div
                    id="flow-description-desktop"
                    class="bg-black/80 backdrop-blur-xl border border-white/20 px-6 py-3 rounded-full text-sm text-gray-100 shadow-2xl transition-all duration-300 opacity-0 translate-y-4"
                >
                    Hover components to reveal details
                </div>
            </div>

            <!-- Observability -->
            <div
                id="node-observability"
                class="flow-node opacity-0 bg-red-900/20 border border-red-500/30 p-4 rounded-2xl backdrop-blur-sm hover:scale-105 transition-all duration-500 cursor-help"
                data-desc={nodes.observability.description}
            >
                <div
                    class="text-xs text-red-200/80 mb-2 font-bold uppercase tracking-wider text-right"
                >
                    Observability
                </div>
                <div class="flex gap-3">
                    {
                        nodes.observability.icons.map((i) => (
                            <Icon name={`devicon:${i}`} class="w-6 h-6" />
                        ))
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes drop-in {
        0% {
            transform: translateY(-50px);
            opacity: 0;
        }
        100% {
            transform: translateY(0);
            opacity: 1;
        }
    }
    @keyframes drop-in-bounce {
        0% {
            transform: translateY(-150px) scale(0.8);
            opacity: 0;
        }
        60% {
            transform: translateY(10px) scale(1.05);
            opacity: 1;
        }
        100% {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
    }
    @keyframes fade-in {
        0% {
            opacity: 0;
        }
        100% {
            opacity: 0.5;
        } /* Target opacity for arrows */
    }

    .animate-drop-in {
        animation: drop-in 0.6s ease-out backwards;
    }
    .animate-drop-in-bounce {
        animation: drop-in-bounce 0.8s cubic-bezier(0.34, 1.56, 0.64, 1)
            backwards;
    }
    .animate-fade-in {
        animation: fade-in 0.5s ease-out backwards;
    }
</style>

<script>
    function setupInteractions() {
        const container = document.getElementById("flow-chart-container");
        const descDesktop = document.getElementById("flow-description-desktop");

        // We use the same description element for simplicity now, or we can keep just one
        if (container && descDesktop) {
            container.querySelectorAll(".flow-node").forEach((node) => {
                // Mouse enter
                node.addEventListener("mouseenter", () => {
                    const text = node.getAttribute("data-desc");
                    if (text) {
                        descDesktop.textContent = text;
                        descDesktop.classList.remove(
                            "opacity-0",
                            "translate-y-4",
                        );
                    }
                });

                // Mouse leave
                node.addEventListener("mouseleave", () => {
                    descDesktop.classList.add("opacity-0", "translate-y-4");
                });

                // Click (for mobile support)
                node.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const text = node.getAttribute("data-desc");
                    if (text) {
                        descDesktop.textContent = text;
                        descDesktop.classList.remove(
                            "opacity-0",
                            "translate-y-4",
                        );
                    }
                });
            });

            // Clear on outside click
            document.addEventListener("click", () => {
                descDesktop.classList.add("opacity-0", "translate-y-4");
            });
        }
    }

    document.addEventListener("astro:page-load", setupInteractions);
</script>
