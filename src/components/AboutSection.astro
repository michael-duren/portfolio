---
import { Image } from "astro:assets";
import SolutionContext from "./SolutionContext.astro";
import meJem from "../images/me-jem.jpeg";
import mePresenting from "../images/me-presenting.jpeg";
import mePrime from "../images/me-prime.jpeg";
import meThat from "../images/me-that.jpeg";

import headshot from "../images/headshot.jpg";

const images = [mePresenting, mePrime, meJem, meThat];

import SketchArrow from "./SketchArrow.astro";
import Technologies from "./Technologies.astro";
import TechFlowChart from "./TechFlowChart.astro";
---

<section
  id="about"
  class="py-24 px-4 w-full relative scroll-mt-16 my-8 rounded-2xl"
>
  <div class="flex flex-col gap-16 w-full">
    <!-- 1. Text Content -->
    <div
      class="max-w-4xl mx-auto w-full space-y-8 animate-on-scroll opacity-0 translate-y-10 transition-all duration-700 relative"
    >
      <!-- Glass Card Container -->
      <div
        class="bg-gray-800/50 backdrop-blur-md border border-gray-700/50 rounded-3xl p-8 md:p-12 shadow-xl"
      >
        <div
          class="flex flex-col md:flex-row gap-8 items-center md:items-start"
        >
          <div class="flex-1 space-y-2">
            <h2
              class="text-4xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-blue-500 pb-2"
            >
              About Me
            </h2>
            <div class="h-1 w-20 bg-purple-600 rounded-full"></div>
          </div>
          <div class="relative group">
            <div
              class="absolute -inset-1 bg-gradient-to-r from-purple-600 to-blue-600 rounded-full blur opacity-50 group-hover:opacity-100 transition duration-1000 group-hover:duration-200"
            >
            </div>
            <div
              class="absolute -inset-1 bg-gradient-to-r from-purple-600 to-blue-600 rounded-full blur opacity-50 group-hover:opacity-100 transition duration-1000 group-hover:duration-200 animate-pulse"
            >
            </div>
            <Image
              src={headshot}
              alt="Michael Duren Headshot"
              class="relative w-32 h-32 md:w-40 md:h-40 rounded-full object-cover border-4 border-gray-900 shadow-2xl z-10"
            />
          </div>
        </div>

        <div
          class="prose prose-invert max-w-none text-lg leading-relaxed text-gray-300 mt-8"
        >
          <p>
            I'm a software engineer specialized in building distributed systems,
            cloud infrastructure, and
            <span class="font-semibold text-white">Open Source</span> software. I
            build production observability platforms and developer tools using
            <span class="font-semibold text-blue-400">Typescript</span>,
            <span class="font-semibold text-cyan-400">Go</span>,
            <span class="font-semibold text-purple-400">C#/Java</span>, and
            <span class="font-semibold text-yellow-400">Python</span>.
          </p>

          <p>
            I focus on delivering tangible operational improvements. I've
            architected observability infrastructure that reduced
            <span class="font-semibold text-white"
              >Mean Time To Resolution (MTTR) by 40%</span
            >
            and built Go-based deployment tools that slashed deployment times by
            <span class="font-semibold text-white"
              >78% (from 90 to 20 minutes)</span
            >.
          </p>

          <p>
            Beyond infrastructure, I've built <a
              href="https://www.patterninterruptinc.com/"
              target="_blank"
              class="text-purple-400 font-semibold hover:underline decoration-2 underline-offset-2"
              >Next Step CMS</a
            > with <a
              href="https://www.patterninterruptinc.com/"
              target="_blank"
              class="text-purple-400 font-semibold hover:underline decoration-2 underline-offset-2"
              >Pattern Interrupt</a
            >, a horizontally scalable SaaS platform. I also contribute to <span
              class="font-semibold text-white">Code for Recovery</span
            >, developing open-source tools for the recovery community.
          </p>

          <p>
            I'm drawn to the problems that live between services: how systems
            communicate, fail, recover, and scale.
          </p>
        </div>
      </div>

      <!-- Decorative Arrow -->
      <div
        class="hidden lg:block absolute -bottom-24 -right-12 w-32 h-32 transform rotate-12"
      >
        <SketchArrow
          variant="curved-right"
          class="w-full h-full text-gray-400/50"
        />
      </div>
    </div>

    <!-- 2. High Def Monitor Display (Speaking and Community) -->
    <div
      class="w-full flex flex-col items-center justify-center relative animate-on-scroll opacity-0 translate-y-10 transition-all duration-700 delay-200"
    >
      <div class="w-full max-w-4xl space-y-8">
        <h3 class="text-2xl font-bold text-gray-100 text-center">
          Speaking and Community
        </h3>
        <p class="text-center text-gray-300 max-w-2xl mx-auto">
          I've given talks, taught courses on popular topics in .NET and Go,
          community is huge and through my career I've got to meet and learn
          from some of the best engineers in the world.
        </p>

        <div class="relative w-full aspect-[21/9]">
          <!-- Monitor Frame -->
          <div
            class="relative bg-gray-900 rounded-lg shadow-2xl border-[4px] border-gray-800 overflow-hidden ring-1 ring-white/10 h-full flex flex-col"
          >
            <!-- Monitor Screen Content -->
            <div class="bg-gray-950 flex-1 relative overflow-hidden group">
              <!-- Wallpaper/Background Glow -->
              <div
                class="absolute inset-0 bg-gradient-to-br from-purple-900/20 to-blue-900/10 pointer-events-none"
              >
              </div>

              <!-- Windows Grid (4 Columns) -->
              <div class="grid grid-cols-4 gap-4 h-full p-4">
                {
                  images.slice(0, 4).map((img, index) => (
                    <div class="relative rounded-md overflow-hidden border border-white/10 shadow-lg group-hover:scale-[1.01] transition-transform duration-500 origin-center z-10 bg-gray-900">
                      <Image
                        src={img}
                        alt={`Community event ${index + 1}`}
                        class="w-full h-full object-cover opacity-90 hover:opacity-100 transition-opacity"
                      />
                    </div>
                  ))
                }
              </div>
            </div>

            <!-- Bottom Bezel with Logo -->
            <div
              class="h-8 bg-gray-900 flex items-center justify-center border-t border-gray-800 relative z-20"
            >
              <div
                class="text-[10px] font-sans font-bold tracking-[0.3em] text-gray-600 uppercase"
              >
                DurenView
              </div>
            </div>
          </div>

          <!-- Monitor Stand -->
          <div
            class="absolute left-1/2 -translate-x-1/2 -bottom-10 w-48 h-12 bg-gradient-to-b from-gray-700 to-gray-800 -z-10 rounded-b shadow-lg clip-path-trapezoid"
          >
          </div>
        </div>
      </div>
      <!-- Decorative Arrow to Technologies -->
      <div
        class="hidden lg:block absolute -bottom-24 left-1/4 w-32 h-32 transform -rotate-12 z-0"
      >
        <SketchArrow
          variant="curved-left"
          class="w-full h-full text-gray-400/50"
        />
      </div>
    </div>

    <!-- 3. Technologies -->
    <div
      class="w-full max-w-4xl mx-auto animate-on-scroll opacity-0 translate-y-10 transition-all duration-700 delay-300"
    >
      <h3 class="text-2xl font-bold mb-2 text-gray-100 text-center">
        Step into my laboratory
      </h3>
      <p class="text-center text-gray-400 text-sm mb-6 font-mono">
        chemicals and potions I use to craft cutting edge solutions
      </p>

      <!-- Technologies Grid with IDs for animation targeting -->
      <div id="technologies-container">
        <Technologies />
      </div>

      <!-- Tech Flow Chart -->
      <div
        class="mt-16 w-full animate-on-scroll opacity-0 translate-y-10 transition-all duration-700 delay-400 group/chart"
        id="chart-container"
      >
        <h3 class="text-2xl font-bold mb-2 text-gray-100 text-center">
          Crafted engineered solutions.
        </h3>
        <p class="text-center text-gray-400 text-sm mb-6 font-mono">
          Measuring, mixing, and combining technologies...
        </p>
        <TechFlowChart />
      </div>

      <!-- 4. Solution Context -->
      <SolutionContext />
    </div>
  </div>
</section>

<script>
  // Animation Orchestration
  document.addEventListener("astro:page-load", () => {
    // 1. Initial Scroll Reveal
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.remove("opacity-0", "translate-y-10");
            observer.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.1 },
    );

    document.querySelectorAll(".animate-on-scroll").forEach((el) => {
      observer.observe(el);
    });

    // 2. Pouring Animation Logic
    const chartContainer = document.getElementById("chart-container");
    const statusTextContainer = document.getElementById("mixing-status");
    const skipBtn = document.getElementById("skip-animation-btn");
    let hasRunAnimation = false;
    let isSkipped = false;

    // Helper to update status
    const updateStatus = (text: string, color: string = "text-purple-300") => {
      if (!statusTextContainer) return;
      // Fade out
      statusTextContainer.classList.remove("opacity-100");
      statusTextContainer.classList.add("opacity-0");

      setTimeout(() => {
        const span = statusTextContainer.querySelector("span");
        if (span) {
          span.textContent = text;
          span.className = `inline-block px-4 py-1 rounded-full bg-black/60 backdrop-blur-md border border-white/10 text-xs font-mono shadow-xl ${color}`;
        }
        statusTextContainer.classList.remove("opacity-0");
        statusTextContainer.classList.add("opacity-100");
      }, 100); // Faster fade transition
    };

    const runPouringSequence = async () => {
      if (hasRunAnimation) return;
      hasRunAnimation = true;

      // Show Skip Button
      if (skipBtn) {
        skipBtn.classList.remove("opacity-0", "pointer-events-none");
      }

      const sleep = (ms: number) => new Promise((r) => setTimeout(r, ms));

      // Helper to animate particle
      const animateParticle = (sourceEl: Element, targetId: string) => {
        if (isSkipped) return;
        const sourceRect = sourceEl.getBoundingClientRect();
        const targetEl = document.getElementById(targetId);
        if (!targetEl) return;
        const targetRect = targetEl.getBoundingClientRect();

        // Create particle
        const particle = document.createElement("div");
        particle.classList.add(
          "fixed",
          "z-50",
          "pointer-events-none",
          "transition-all",
          "duration-500", // Faster flight duration
          "ease-in-out",
        );
        particle.style.left = `${sourceRect.left + sourceRect.width / 2}px`;
        particle.style.top = `${sourceRect.top + sourceRect.height / 2}px`;
        particle.style.width = "12px";
        particle.style.height = "12px";
        particle.style.borderRadius = "50%";
        particle.style.backgroundColor =
          getComputedStyle(sourceEl.querySelector("span") || sourceEl).color ||
          "white";
        particle.style.boxShadow = "0 0 10px currentColor";

        document.body.appendChild(particle);

        // Animate
        requestAnimationFrame(() => {
          particle.style.transform = `translate(${targetRect.left - sourceRect.left}px, ${targetRect.top - sourceRect.top}px) scale(0.5)`;
          particle.style.opacity = "0";
        });

        // Cleanup
        setTimeout(() => {
          particle.remove();
        }, 500);
      };

      // Sequence Groups
      const sequence = [
        {
          target: "node-web",
          label: "Building Interactive UI...",
          color: "text-blue-300",
        },
        {
          target: "node-k8s",
          label: "Orchestrating Infrastructure...",
          color: "text-blue-500",
        },
        {
          target: "node-cloud",
          label: "Provisioning Cloud Resources...",
          color: "text-yellow-500",
        },
        {
          target: "node-services",
          label: "Deploying Microservices...",
          color: "text-indigo-400",
        },
        {
          target: "node-db",
          label: "Connecting Data Layer...",
          color: "text-green-400",
        },
        {
          target: "node-tools",
          label: "Automating Pipelines...",
          color: "text-yellow-600",
        },
        {
          target: "node-observability",
          label: "Adding Observability...",
          color: "text-red-400",
        },
      ];

      for (const step of sequence) {
        if (isSkipped) break;
        updateStatus(step.label, step.color);

        // Find sources for this target
        const sources = document.querySelectorAll(
          `[data-target="${step.target}"]`,
        );

        // Launch particles
        sources.forEach((source, idx) => {
          if (!isSkipped) {
            setTimeout(() => animateParticle(source, step.target), idx * 30);
          }
        });

        if (!isSkipped) await sleep(200 + sources.length * 30);

        // Reveal Target Node
        const targetNode = document.getElementById(step.target);
        if (targetNode && !isSkipped) {
          targetNode.classList.remove(
            "opacity-0",
            "translate-y-4",
            "-translate-x-4",
            "translate-x-4",
          );
          // Reveal arrow connectors if any exist near this node (simplified)
          const parent = targetNode.parentElement;
          if (parent) {
            const arrows = parent.querySelectorAll(".arrow-connector");
            arrows.forEach((a) => a.classList.remove("opacity-0"));
          }
        }

        if (!isSkipped) await sleep(50);
      }

      finishAnimation();
    };

    const finishAnimation = () => {
      isSkipped = true;

      // Hide Skip Button
      if (skipBtn) {
        skipBtn.classList.add("opacity-0", "pointer-events-none");
      }

      // Force reveal all nodes
      const allNodes = document.querySelectorAll(".flow-node");
      allNodes.forEach((node) => {
        node.classList.remove(
          "opacity-0",
          "translate-y-4",
          "-translate-x-4",
          "translate-x-4",
        );
      });

      // Force reveal all arrows
      const allArrows = document.querySelectorAll(".arrow-connector");
      allArrows.forEach((arrow) => {
        arrow.classList.remove("opacity-0");
      });

      updateStatus("Solution Engineered.", "text-green-400 font-bold");

      // Reveal Solution Context
      const solContext = document.getElementById("solution-context");
      if (solContext) {
        solContext.classList.remove("opacity-0");
        const items = solContext.querySelectorAll("[data-animate-solution]");
        items.forEach((item) => item.classList.add("show"));
      }
    };

    if (skipBtn) {
      skipBtn.addEventListener("click", finishAnimation);
    }

    // Trigger animation when chart comes into view
    const chartObserver = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && !hasRunAnimation) {
            // Wait a bit for the chart to be fully visible and refined
            setTimeout(runPouringSequence, 200);
            chartObserver.disconnect();
          }
        });
      },
      { threshold: 0.5 },
    );

    if (chartContainer) {
      chartObserver.observe(chartContainer);
    }
  });
</script>
